var
	tests = require('./lib/testconnector2.js'),
	Results = require('./lib/results').Results,
	fs = require('fs'),
	t;

// t = testconnector.testconnector({
// 	'cmd': '/root/fedlab/simplesamlphp-test/modules/fedlab/bin/cmd.php',
// 	"metadata":"<md:EntityDescriptor xmlns:md=\"urn:oasis:names:tc:SAML:2.0:metadata\" entityID=\"https:\/\/skjak.uninett.no\/simplesaml\/module.php\/saml\/sp\/metadata.php\/fedlab-test-sp\"><md:Extensions><mdattr:EntityAttributes xmlns:mdattr=\"urn:oasis:names:tc:SAML:metadata:attribute\"><saml:Attribute xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\" Name=\"https:\/\/www.fed-lab.org\/attributes\/initsso\" NameFormat=\"urn:oasis:names:tc:SAML:2.0:attrname-format:uri\"><saml:AttributeValue>https:\/\/skjak.uninett.no\/simplesaml\/module.php\/core\/authenticate.php?as=fedlab-test-sp<\/saml:AttributeValue><\/saml:Attribute><saml:Attribute xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\" Name=\"https:\/\/www.fed-lab.org\/attributes\/attributeurl\" NameFormat=\"urn:oasis:names:tc:SAML:2.0:attrname-format:uri\"><saml:AttributeValue>https:\/\/skjak.uninett.no\/simplesaml\/module.php\/core\/authenticate.php?as=fedlab-test-sp<\/saml:AttributeValue><\/saml:Attribute><saml:Attribute xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\" Name=\"https:\/\/www.fed-lab.org\/attributes\/initslo\" NameFormat=\"urn:oasis:names:tc:SAML:2.0:attrname-format:uri\"><saml:AttributeValue>https:\/\/skjak.uninett.no\/simplesaml\/module.php\/core\/authenticate.php?as=fedlab-test-sp&amp;logout<\/saml:AttributeValue><\/saml:Attribute><\/mdattr:EntityAttributes><\/md:Extensions><md:SPSSODescriptor protocolSupportEnumeration=\"urn:oasis:names:tc:SAML:1.1:protocol urn:oasis:names:tc:SAML:2.0:protocol\"><md:Extensions><mdui:UIInfo xmlns:mdui=\"urn:oasis:names:tc:SAML:metadata:ui\" xmlns:md=\"urn:oasis:names:tc:SAML:2.0:metadata\">\n                <mdui:DisplayName xml:lang=\"en\">SimpleSAMLphp (Skjak, recent version)<\/mdui:DisplayName>\n            <\/mdui:UIInfo><\/md:Extensions><md:KeyDescriptor use=\"signing\"><ds:KeyInfo xmlns:ds=\"http:\/\/www.w3.org\/2000\/09\/xmldsig#\"><ds:X509Data><ds:X509Certificate>MIICKzCCAZQCCQD9rDqbOSrq\/zANBgkqhkiG9w0BAQUFADBaMQswCQYDVQQGEwJOTzEKMAgGA1UECBMBIDESMBAGA1UEBxMJVHJvbmRoZWltMRAwDgYDVQQKEwdVTklORVRUMRkwFwYDVQQDExBza2phay51bmluZXR0Lm5vMB4XDTA3MDcxMzA1MTIxOFoXDTA4MDcxMjA1MTIxOFowWjELMAkGA1UEBhMCTk8xCjAIBgNVBAgTASAxEjAQBgNVBAcTCVRyb25kaGVpbTEQMA4GA1UEChMHVU5JTkVUVDEZMBcGA1UEAxMQc2tqYWsudW5pbmV0dC5ubzCBnzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEAqpdnMQWClY2BMTrO\/vBou+8GmdYjfNzTAsggdDVex1+R\/lQvyJCe+bb0PRn0Lzxukbgt+Tuq65po+7Klpy7pyCUnxFxXXQoClh6W8P7hfzGDYehcrALGd2pRl2RYwZV0FZ0aoECKRFC6KKZ\/21ZSDhgc\/zcg\/9UEOpsh8OzITc8CAwEAATANBgkqhkiG9w0BAQUFAAOBgQAYCtx6fUMt3Chc2RDLSuBjlpGMenGRVMNGDf1QpMY3zwYhOAdi8ZUJub9Vi4RLB\/eBfL9sGOWF+yPmU43rxZzM7L8VPzfxHHxATX2kmTJo3Qd46F0EnIHwLOCKb\/mRTs9lAhNz3pENiQyQCDaxCFtDlXuvm5yScjdohtaqtCSETQ==<\/ds:X509Certificate><\/ds:X509Data><\/ds:KeyInfo><\/md:KeyDescriptor><md:KeyDescriptor use=\"encryption\"><ds:KeyInfo xmlns:ds=\"http:\/\/www.w3.org\/2000\/09\/xmldsig#\"><ds:X509Data><ds:X509Certificate>MIICKzCCAZQCCQD9rDqbOSrq\/zANBgkqhkiG9w0BAQUFADBaMQswCQYDVQQGEwJOTzEKMAgGA1UECBMBIDESMBAGA1UEBxMJVHJvbmRoZWltMRAwDgYDVQQKEwdVTklORVRUMRkwFwYDVQQDExBza2phay51bmluZXR0Lm5vMB4XDTA3MDcxMzA1MTIxOFoXDTA4MDcxMjA1MTIxOFowWjELMAkGA1UEBhMCTk8xCjAIBgNVBAgTASAxEjAQBgNVBAcTCVRyb25kaGVpbTEQMA4GA1UEChMHVU5JTkVUVDEZMBcGA1UEAxMQc2tqYWsudW5pbmV0dC5ubzCBnzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEAqpdnMQWClY2BMTrO\/vBou+8GmdYjfNzTAsggdDVex1+R\/lQvyJCe+bb0PRn0Lzxukbgt+Tuq65po+7Klpy7pyCUnxFxXXQoClh6W8P7hfzGDYehcrALGd2pRl2RYwZV0FZ0aoECKRFC6KKZ\/21ZSDhgc\/zcg\/9UEOpsh8OzITc8CAwEAATANBgkqhkiG9w0BAQUFAAOBgQAYCtx6fUMt3Chc2RDLSuBjlpGMenGRVMNGDf1QpMY3zwYhOAdi8ZUJub9Vi4RLB\/eBfL9sGOWF+yPmU43rxZzM7L8VPzfxHHxATX2kmTJo3Qd46F0EnIHwLOCKb\/mRTs9lAhNz3pENiQyQCDaxCFtDlXuvm5yScjdohtaqtCSETQ==<\/ds:X509Certificate><\/ds:X509Data><\/ds:KeyInfo><\/md:KeyDescriptor><md:SingleLogoutService Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect\" Location=\"https:\/\/skjak.uninett.no\/simplesaml\/module.php\/saml\/sp\/saml2-logout.php\/fedlab-test-sp\"\/><md:AssertionConsumerService Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST\" Location=\"https:\/\/skjak.uninett.no\/simplesaml\/module.php\/saml\/sp\/saml2-acs.php\/fedlab-test-sp\" index=\"0\"\/><md:AssertionConsumerService Binding=\"urn:oasis:names:tc:SAML:1.0:profiles:browser-post\" Location=\"https:\/\/skjak.uninett.no\/simplesaml\/module.php\/saml\/sp\/saml1-acs.php\/fedlab-test-sp\" index=\"1\"\/><md:AssertionConsumerService Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Artifact\" Location=\"https:\/\/skjak.uninett.no\/simplesaml\/module.php\/saml\/sp\/saml2-acs.php\/fedlab-test-sp\" index=\"2\"\/><md:AssertionConsumerService Binding=\"urn:oasis:names:tc:SAML:1.0:profiles:artifact-01\" Location=\"https:\/\/skjak.uninett.no\/simplesaml\/module.php\/saml\/sp\/saml1-acs.php\/fedlab-test-sp\/artifact\" index=\"3\"\/><md:AttributeConsumingService index=\"0\"><md:ServiceName xml:lang=\"en\">SimpleSAMLphp (Skjak, recent version)<\/md:ServiceName><md:RequestedAttribute Name=\"urn:oid:1.3.6.1.4.1.5923.1.1.1.6\"\/><md:RequestedAttribute Name=\"urn:oid:1.3.6.1.4.1.5923.1.1.1.6\"\/><\/md:AttributeConsumingService><\/md:SPSSODescriptor><md:ContactPerson contactType=\"technical\"><md:GivenName>Olav<\/md:GivenName><md:SurName>Morken<\/md:SurName><md:EmailAddress>olav.morken@uninett.no<\/md:EmailAddress><\/md:ContactPerson><\/md:EntityDescriptor>"
// });

// t.getFlows(function(list, stderr) {
// 	console.log(list);
	
// 	console.log('Error:');
// 	console.log(stderr);
// });

var metadata = "<md:EntityDescriptor xmlns:md=\"urn:oasis:names:tc:SAML:2.0:metadata\" entityID=\"https:\/\/skjak.uninett.no\/simplesaml\/module.php\/saml\/sp\/metadata.php\/fedlab-test-sp\"><md:Extensions><mdattr:EntityAttributes xmlns:mdattr=\"urn:oasis:names:tc:SAML:metadata:attribute\"><saml:Attribute xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\" Name=\"https:\/\/www.fed-lab.org\/attributes\/initsso\" NameFormat=\"urn:oasis:names:tc:SAML:2.0:attrname-format:uri\"><saml:AttributeValue>https:\/\/skjak.uninett.no\/simplesaml\/module.php\/core\/authenticate.php?as=fedlab-test-sp<\/saml:AttributeValue><\/saml:Attribute><saml:Attribute xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\" Name=\"https:\/\/www.fed-lab.org\/attributes\/attributeurl\" NameFormat=\"urn:oasis:names:tc:SAML:2.0:attrname-format:uri\"><saml:AttributeValue>https:\/\/skjak.uninett.no\/simplesaml\/module.php\/core\/authenticate.php?as=fedlab-test-sp<\/saml:AttributeValue><\/saml:Attribute><saml:Attribute xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\" Name=\"https:\/\/www.fed-lab.org\/attributes\/initslo\" NameFormat=\"urn:oasis:names:tc:SAML:2.0:attrname-format:uri\"><saml:AttributeValue>https:\/\/skjak.uninett.no\/simplesaml\/module.php\/core\/authenticate.php?as=fedlab-test-sp&amp;logout<\/saml:AttributeValue><\/saml:Attribute><\/mdattr:EntityAttributes><\/md:Extensions><md:SPSSODescriptor protocolSupportEnumeration=\"urn:oasis:names:tc:SAML:1.1:protocol urn:oasis:names:tc:SAML:2.0:protocol\"><md:Extensions><mdui:UIInfo xmlns:mdui=\"urn:oasis:names:tc:SAML:metadata:ui\" xmlns:md=\"urn:oasis:names:tc:SAML:2.0:metadata\">\n                <mdui:DisplayName xml:lang=\"en\">SimpleSAMLphp (Skjak, recent version)<\/mdui:DisplayName>\n            <\/mdui:UIInfo><\/md:Extensions><md:KeyDescriptor use=\"signing\"><ds:KeyInfo xmlns:ds=\"http:\/\/www.w3.org\/2000\/09\/xmldsig#\"><ds:X509Data><ds:X509Certificate>MIICKzCCAZQCCQD9rDqbOSrq\/zANBgkqhkiG9w0BAQUFADBaMQswCQYDVQQGEwJOTzEKMAgGA1UECBMBIDESMBAGA1UEBxMJVHJvbmRoZWltMRAwDgYDVQQKEwdVTklORVRUMRkwFwYDVQQDExBza2phay51bmluZXR0Lm5vMB4XDTA3MDcxMzA1MTIxOFoXDTA4MDcxMjA1MTIxOFowWjELMAkGA1UEBhMCTk8xCjAIBgNVBAgTASAxEjAQBgNVBAcTCVRyb25kaGVpbTEQMA4GA1UEChMHVU5JTkVUVDEZMBcGA1UEAxMQc2tqYWsudW5pbmV0dC5ubzCBnzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEAqpdnMQWClY2BMTrO\/vBou+8GmdYjfNzTAsggdDVex1+R\/lQvyJCe+bb0PRn0Lzxukbgt+Tuq65po+7Klpy7pyCUnxFxXXQoClh6W8P7hfzGDYehcrALGd2pRl2RYwZV0FZ0aoECKRFC6KKZ\/21ZSDhgc\/zcg\/9UEOpsh8OzITc8CAwEAATANBgkqhkiG9w0BAQUFAAOBgQAYCtx6fUMt3Chc2RDLSuBjlpGMenGRVMNGDf1QpMY3zwYhOAdi8ZUJub9Vi4RLB\/eBfL9sGOWF+yPmU43rxZzM7L8VPzfxHHxATX2kmTJo3Qd46F0EnIHwLOCKb\/mRTs9lAhNz3pENiQyQCDaxCFtDlXuvm5yScjdohtaqtCSETQ==<\/ds:X509Certificate><\/ds:X509Data><\/ds:KeyInfo><\/md:KeyDescriptor><md:KeyDescriptor use=\"encryption\"><ds:KeyInfo xmlns:ds=\"http:\/\/www.w3.org\/2000\/09\/xmldsig#\"><ds:X509Data><ds:X509Certificate>MIICKzCCAZQCCQD9rDqbOSrq\/zANBgkqhkiG9w0BAQUFADBaMQswCQYDVQQGEwJOTzEKMAgGA1UECBMBIDESMBAGA1UEBxMJVHJvbmRoZWltMRAwDgYDVQQKEwdVTklORVRUMRkwFwYDVQQDExBza2phay51bmluZXR0Lm5vMB4XDTA3MDcxMzA1MTIxOFoXDTA4MDcxMjA1MTIxOFowWjELMAkGA1UEBhMCTk8xCjAIBgNVBAgTASAxEjAQBgNVBAcTCVRyb25kaGVpbTEQMA4GA1UEChMHVU5JTkVUVDEZMBcGA1UEAxMQc2tqYWsudW5pbmV0dC5ubzCBnzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEAqpdnMQWClY2BMTrO\/vBou+8GmdYjfNzTAsggdDVex1+R\/lQvyJCe+bb0PRn0Lzxukbgt+Tuq65po+7Klpy7pyCUnxFxXXQoClh6W8P7hfzGDYehcrALGd2pRl2RYwZV0FZ0aoECKRFC6KKZ\/21ZSDhgc\/zcg\/9UEOpsh8OzITc8CAwEAATANBgkqhkiG9w0BAQUFAAOBgQAYCtx6fUMt3Chc2RDLSuBjlpGMenGRVMNGDf1QpMY3zwYhOAdi8ZUJub9Vi4RLB\/eBfL9sGOWF+yPmU43rxZzM7L8VPzfxHHxATX2kmTJo3Qd46F0EnIHwLOCKb\/mRTs9lAhNz3pENiQyQCDaxCFtDlXuvm5yScjdohtaqtCSETQ==<\/ds:X509Certificate><\/ds:X509Data><\/ds:KeyInfo><\/md:KeyDescriptor><md:SingleLogoutService Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect\" Location=\"https:\/\/skjak.uninett.no\/simplesaml\/module.php\/saml\/sp\/saml2-logout.php\/fedlab-test-sp\"\/><md:AssertionConsumerService Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST\" Location=\"https:\/\/skjak.uninett.no\/simplesaml\/module.php\/saml\/sp\/saml2-acs.php\/fedlab-test-sp\" index=\"0\"\/><md:AssertionConsumerService Binding=\"urn:oasis:names:tc:SAML:1.0:profiles:browser-post\" Location=\"https:\/\/skjak.uninett.no\/simplesaml\/module.php\/saml\/sp\/saml1-acs.php\/fedlab-test-sp\" index=\"1\"\/><md:AssertionConsumerService Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Artifact\" Location=\"https:\/\/skjak.uninett.no\/simplesaml\/module.php\/saml\/sp\/saml2-acs.php\/fedlab-test-sp\" index=\"2\"\/><md:AssertionConsumerService Binding=\"urn:oasis:names:tc:SAML:1.0:profiles:artifact-01\" Location=\"https:\/\/skjak.uninett.no\/simplesaml\/module.php\/saml\/sp\/saml1-acs.php\/fedlab-test-sp\/artifact\" index=\"3\"\/><md:AttributeConsumingService index=\"0\"><md:ServiceName xml:lang=\"en\">SimpleSAMLphp (Skjak, recent version)<\/md:ServiceName><md:RequestedAttribute Name=\"urn:oid:1.3.6.1.4.1.5923.1.1.1.6\"\/><md:RequestedAttribute Name=\"urn:oid:1.3.6.1.4.1.5923.1.1.1.6\"\/><\/md:AttributeConsumingService><\/md:SPSSODescriptor><md:ContactPerson contactType=\"technical\"><md:GivenName>Olav<\/md:GivenName><md:SurName>Morken<\/md:SurName><md:EmailAddress>olav.morken@uninett.no<\/md:EmailAddress><\/md:ContactPerson><\/md:EntityDescriptor>";

fs.readFile(__dirname + '/etc/config.js', function (err, data) {
	if (err) {
		console.log("Error reading config results");
		return null;
	}
	config = JSON.parse(data);
	console.log("Successfully read configuration.");
	console.log(config);

	t = new tests.OICTestconnector(config);
	t.definitions(function(data) {
		console.log("Definitions...:");
		console.log(JSON.stringify(data, null, 4));
	});

	t.verify(metadata, function(result) {
		console.log("Results :");
		console.log(JSON.stringify(data, null, 4));
	}, function(err) {
		console.log("ERror :" + err);
	});

});




